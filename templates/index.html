<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>·ª®ng d·ª•ng ph√¢n bi·ªát g·∫°o</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 24px;
      max-width: 800px;
      margin: auto;
      background: #f9fafb;
      color: #222;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    input[type=file], button {
      display: block;
      margin: 16px 0;
    }
    button {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    img {
      max-width: 300px;
      margin-top: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .result {
      margin-top: 18px;
      padding: 12px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    }
    .group-vn { color: #00b33c; font-weight: bold; }      /* xanh l√° */
    .group-foreign { color: #007bff; font-weight: bold; } /* xanh d∆∞∆°ng */
    .group-unknown { color: #888; font-weight: bold; }    /* x√°m */
  </style>
</head>
<body>
  <h2>üåæ ·ª®ng d·ª•ng h·ªçc m√°y ph√¢n bi·ªát g·∫°o Vi·ªát Nam (MobileNetV2) üåæ</h2>
  <p>T·∫£i ·∫£nh g·∫°o l√™n, ·ª©ng d·ª•ng s·∫Ω d·ª± ƒëo√°n lo·∫°i g·∫°o v√† ph√¢n lo·∫°i theo ngu·ªìn g·ªëc.</p>

  <input id="fileinput" type="file" accept="image/*" />
  <button id="btn">D·ª± ƒëo√°n</button>

  <div id="preview"></div>
  <div class="result" id="out"></div>

  <script>
    const fileInput = document.getElementById("fileinput");
    const previewDiv = document.getElementById("preview");
    const out = document.getElementById("out");
    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        previewDiv.innerHTML = `<img src="${url}" alt="preview"/>`;
        out.innerHTML = ""; // x√≥a k·∫øt qu·∫£ c≈©
      }
    };
    document.getElementById("btn").onclick = async () => {
      const f = fileInput.files[0];
      if (!f) { alert("Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc."); return; }
      const fd = new FormData();
      fd.append("file", f);
      out.innerHTML = "<i>ƒêang x·ª≠ l√Ω... (CPU mi·ªÖn ph√≠ c√≥ th·ªÉ m·∫•t 1-2 ph√∫t)</i>"; // <--- S·ª¨A NH·ªé
      try {
        const res = await fetch("/predict", { method: "POST", body: fd });
        // --- (PH·∫¶N S·ª¨A ƒê·ªÇ CH·ªêNG L·ªñI) ---
        // ƒê·ªçc k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng TEXT tr∆∞·ªõc
        const text = await res.text();
        let json;
        
        try {
          // Th·ª≠ chuy·ªÉn text sang JSON
          json = JSON.parse(text);
        } catch (e) {
          // N·∫øu th·∫•t b·∫°i, nghƒ©a l√† server tr·∫£ v·ªÅ HTML l·ªói (v√≠ d·ª• 502)
          out.innerHTML = `<b style="color:red;">L·ªói:</b> Server kh√¥ng tr·∫£ v·ªÅ JSON h·ª£p l·ªá. C√≥ th·ªÉ server b·ªã s·∫≠p ho·∫∑c h·∫øt gi·ªù.`;
          console.error("Server response was not JSON:", text.slice(0, 200));
          return;
        }
        // --- (H·∫æT PH·∫¶N S·ª¨A) ---
        if (json.error) {
          out.innerHTML = `<b style="color:red;">L·ªói:</b> ${json.error}`;
          return;
        }
        const group = (json.group || "").trim(); // group b·∫±ng ti·∫øng Vi·ªát
        let html = "";
        // ch·ªâ hi·ªán D·ª± ƒëo√°n n·∫øu KH√îNG ph·∫£i "Kh√¥ng x√°c ƒë·ªãnh"
        if (group && group !== "Kh√¥ng x√°cid") {
          html += `<div>D·ª± ƒëo√°n: <b>${json.label}</b> (ƒê·ªô ch√≠nh x√°c: ${(json.prob * 100).toFixed(2)}%)</div>`; // <--- S·ª¨A NH·ªé (hi·ªán %)
        }
        let group_class =
          group === "G·∫°o Vi·ªát Nam" ? "group-vn" :
          group === "G·∫°o n∆∞·ªõc ngo√†i" ? "group-foreign" :
          "group-unknown";
        html += `<div>Nh√≥m: <span class="${group_class}">${json.group}</span></div>`;
        out.innerHTML = html;
      } catch (err) {
        // L·ªói n√†y x·∫£y ra n·∫øu m·∫°ng b·ªã ng·∫Øt
        out.innerHTML = `<b style="color:red;">L·ªói M·∫°ng:</b> ${err.message}`;
      }
    };
  </script>
</body>
</html>
