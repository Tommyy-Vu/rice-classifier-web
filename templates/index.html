<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>·ª®ng d·ª•ng ph√¢n bi·ªát g·∫°o</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 24px;
      max-width: 800px;
      margin: auto;
      background: #f9fafb;
      color: #222;
    }
    h2 { text-align: center; color: #333; }
    input[type=file], button {
      display: block;
      margin: 16px 0;
    }
    button {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    img {
      max-width: 300px;
      margin-top: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .result {
      margin-top: 18px;
      padding: 12px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    }
    .group-vn { color: #00b33c; font-weight: bold; }       /* xanh l√° */
    .group-foreign { color: #007bff; font-weight: bold; }  /* xanh d∆∞∆°ng */
    .group-unknown { color: #888; font-weight: bold; }     /* x√°m */
  </style>
</head>
<body>
  <h2>üåæ ·ª®ng d·ª•ng h·ªçc m√°y ph√¢n bi·ªát g·∫°o Vi·ªát Nam (MobileNetV2) üåæ</h2>
  <p>T·∫£i ·∫£nh g·∫°o l√™n, ·ª©ng d·ª•ng s·∫Ω d·ª± ƒëo√°n lo·∫°i g·∫°o v√† ph√¢n lo·∫°i theo ngu·ªìn g·ªëc.</p>

  <input id="fileinput" type="file" accept="image/*" />
  <button id="btn">D·ª± ƒëo√°n</button>

  <div id="preview"></div>
  <div class="result" id="out"></div>

  <script>
    const fileInput = document.getElementById("fileinput");
    const previewDiv = document.getElementById("preview");
    const out = document.getElementById("out");

    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        previewDiv.innerHTML = `<img src="${url}" alt="preview"/>`;
        out.innerHTML = ""; // x√≥a k·∫øt qu·∫£ c≈©
      }
    };

    document.getElementById("btn").onclick = async () => {
      const f = fileInput.files[0];
      if (!f) {
        alert("Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc.");
        return;
      }

      const fd = new FormData();
      fd.append("file", f);
      out.innerHTML = "<i>ƒêang x·ª≠ l√Ω...</i>";

      try {
        const res = await fetch("/predict", { method: "POST", body: fd });

        // --- üß† Fix quan tr·ªçng: ch·ªâ parse JSON n·∫øu c√≥ th·ªÉ ---
        const text = await res.text();
        let json;
        try {
          json = JSON.parse(text);
        } catch {
          throw new Error("Server kh√¥ng tr·∫£ v·ªÅ JSON h·ª£p l·ªá: " + text.slice(0, 200));
        }

        if (json.error) {
          out.innerHTML = `<b style="color:red;">L·ªói:</b> ${json.error}`;
          return;
        }

        const group = (json.group || "").trim();
        let html = "";

        if (group && group !== "Kh√¥ng x√°c ƒë·ªãnh") {
          html += `<div>D·ª± ƒëo√°n: <b>${json.label}</b> (p=${json.prob})</div>`;
        }

        const groupClass =
          group === "G·∫°o Vi·ªát Nam" ? "group-vn" :
          group === "G·∫°o n∆∞·ªõc ngo√†i" ? "group-foreign" :
          "group-unknown";

        html += `<div>Nh√≥m: <span class="${groupClass}">${json.group}</span></div>`;
        out.innerHTML = html;

      } catch (err) {
        console.error("Fetch error:", err);
        out.innerHTML = `<b style="color:red;">L·ªói:</b> ${err.message || err}`;
      }
    };
  </script>
</body>
</html>
